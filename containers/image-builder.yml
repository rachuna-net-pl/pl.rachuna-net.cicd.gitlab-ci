---
# -----------------------------------------------------------------------------
# GitLab CI configuration for containers image builder.
# -----------------------------------------------------------------------------
include:
  - local: _common.yml
  - component: $CI_SERVER_FQDN/pl.rachuna-net/cicd/components/validate/contrest@v1.0.0
    inputs:
      source_files: "config.yml"
      namespace_policy: image_builder
  - component: $CI_SERVER_FQDN/pl.rachuna-net/cicd/components/containers/image-builder@v1.0.0
  - component: $CI_SERVER_FQDN/pl.rachuna-net/cicd/components/ast/trivy@v1.0.0


### validate
ğŸ”¬ Validate files (conftest):
  needs:
    - job: ğŸ” Input Parameters
    - job: ğŸ” Analyze Conventional Commits
    - job: ğŸ•µ Set Version

### build
ğŸš€ build container image:
  needs:
    - job: ğŸ•µ YAML lint
      optional: true
    - job: ğŸ”¬ Validate files (conftest)
    - job: ğŸ•µ Set Version
      artifacts: true
  rules:
    - when: on_success

### publish
ğŸŒ publish container image:
  variables:
    CONTAINER_VERSION: $RELEASE_CANDIDATE_VERSION
  needs:
    - job: ğŸ•µ Set Version
      artifacts: true
    - job: ğŸš€ build container image
      artifacts: true
  rules:
    - when: on_success

### integration-test
ğŸ§ª test docker image:
  variables:
    CONTAINER_VERSION: $RELEASE_CANDIDATE_VERSION
  needs:
    - job: ğŸ“ Publish Version
      artifacts: true
    - job: ğŸŒ publish container image
      artifacts: true

ğŸ”¬ trivy (dast):
  allow_failure: true
  variables:
    CONTAINER_TO_ANALYZE: $CI_REGISTRY_IMAGE:$RELEASE_CANDIDATE_VERSION
  needs:
    - job: ğŸ“ Publish Version
      artifacts: true
    - job: ğŸŒ publish container image
      artifacts: true
