---
# -----------------------------------------------------------------------------
# GitLab CI configuration for opentofu.
# -----------------------------------------------------------------------------
include:
  - local: _common.yml
  ### opentofu
  - component: $CI_SERVER_FQDN/pl.rachuna-net/cicd/components/infrastructure/opentofu@v1.0.0

### validate
ğŸ•µ opentofu fmt:
  needs:
    - job: ğŸ” Input Parameters
    - job: ğŸ” Analyze Conventional Commits
    - job: ğŸ•µ Set Version

âœ… opentofu validate:
  needs:
    - job: ğŸ” Input Parameters
    - job: ğŸ” Analyze Conventional Commits
    - job: ğŸ•µ Set Version

âœ… tflint:
  needs:
    - job: ğŸ” Input Parameters
    - job: ğŸ” Analyze Conventional Commits
    - job: ğŸ•µ Set Version

âœ… terraform-docs:
  rules:
    - when: never

### unit-test
ğŸ§ª opentofu plan:
  needs:
    - job: ğŸ•µ YAML lint
      optional: true
    - job: ğŸ•µ opentofu fmt
    - job: âœ… opentofu validate
    - job: âœ… tflint
  rules:
    - when: on_success

### release
ğŸ“ Publish Version:
  needs:
    - job: ğŸ§ª opentofu plan

### deploy
ğŸ’¥ opentofu apply:
  needs:
    - job: ğŸ“ Publish Version
  rules: !reference [.rule:deploy:opentofu, rules]
